name: Create gamma branch in multiple CoverGo repositories

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to create'
        required: true
        type: string

jobs:
  create-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        repository:
          - ChinhTrieu-CoverGo/Reference
          - ChinhTrieu-CoverGo/RequestManager
          # Add more repositories here as needed
          # - CoverGo/Repository3
          # - CoverGo/Repository4
          # ... up to 100 repositories
    steps:
      - name: Checkout ${{ matrix.repository }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repository }}
          token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Create and push branch in ${{ matrix.repository }}
        run: |
          git config user.name "coverbot"
          git config user.email "infrastructure@covergo.com"
          
          # Get the default branch (main or master)
          # Try to get the default branch from remote HEAD
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "")
          
          # If that fails, try common branch names
          if [ -z "$DEFAULT_BRANCH" ]; then
            if git show-ref --verify --quiet refs/remotes/origin/main; then
              DEFAULT_BRANCH="main"
            elif git show-ref --verify --quiet refs/remotes/origin/master; then
              DEFAULT_BRANCH="master"
            else
              echo "❌ Error: Could not determine default branch for ${{ matrix.repository }}"
              exit 1
            fi
          fi
          
          echo "Using default branch: $DEFAULT_BRANCH"
          
          # Checkout the default branch
          git checkout $DEFAULT_BRANCH
          git pull origin $DEFAULT_BRANCH
          
          # Check if branch already exists
          if git show-ref --verify --quiet refs/heads/${{ inputs.branch_name }}; then
            echo "⚠️  Branch '${{ inputs.branch_name }}' already exists locally, checking it out"
            git checkout ${{ inputs.branch_name }}
            git pull origin ${{ inputs.branch_name }} || true
          else
            # Create new branch
            git checkout -b ${{ inputs.branch_name }}
          fi
          
          # Push the new branch
          git push -u origin ${{ inputs.branch_name }}
          
          echo "✅ Successfully created/updated branch '${{ inputs.branch_name }}' in ${{ matrix.repository }}"
          git branch -a
      - name: Update docker image for ${{ matrix.repository }}
        if: matrix.repository == 'ChinhTrieu-CoverGo/RequestManager'
        run: |          
          git checkout ${{ inputs.branch_name }}
          Tests_Acceptance_Amazon_FILE_PATH="docker-compose-tests-acceptance-amazon.yml"
          OLD_AUTH_IMG="image: ghcr.io/covergo/auth:master"
          NEW_AUTH_IMG="image: ghcr.io/covergo/auth:${{ inputs.branch_name }}"

          # Use sed to replace the old auth image with the new one in the docker-compose file
          sed -i "s|$OLD_AUTH_IMG|$NEW_AUTH_IMG|g" "$Tests_Acceptance_Amazon_FILE_PATH"
          # Check if there are any changes
          if git diff --quiet; then
            echo "⚠️  No changes detected"
            exit 0
          fi
          
          # Stage the file
          git add .
          
          # Commit the changes
          git commit -m "chore: update docker image for ${{ inputs.branch_name }}"
          
          # Push to the branch
          git push origin "${{ inputs.branch_name }}"
          
          echo "✅ Successfully committed and pushed docker image update to ${{ inputs.branch_name }}"

          
