name: Create gamma branches in multiple CoverGo repositories

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to create'
        required: true
        type: string

jobs:
  create-branch:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        repository:
          - chinh-trieu-covergo/Reference
          - chinh-trieu-covergo/RequestManager
          # Add more repositories here as needed
          # - CoverGo/Gateway
          # - CoverGo/AnotherRepository
          # - ...
    steps:
      - name: Validate branch name
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          if [[ ! "$BRANCH_NAME" =~ ^[a-zA-Z0-9/_-]+$ ]]; then 
            echo "Invalid branch name. Only alphanumeric characters, hyphens, underscores, and slashes are allowed." 
            exit 1 
          fi
      - name: Checkout ${{ matrix.repository }}
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
        uses: actions/checkout@v4
        with:
          repository: ${{ matrix.repository }}
          token: ${{ secrets.REPO_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      - name: Create and push branch in ${{ matrix.repository }}
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}
        run: |
          git config user.name "coverbot"
          git config user.email "infrastructure@covergo.com"
          
          # Get the default branch (main or master)
          # Try to get the default branch from remote HEAD
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's@^refs/remotes/origin/@@' || echo "")
          
          # If that fails, try common branch names
          if [ -z "$DEFAULT_BRANCH" ]; then
            if git show-ref --verify --quiet refs/remotes/origin/main; then
              DEFAULT_BRANCH="main"
            elif git show-ref --verify --quiet refs/remotes/origin/master; then
              DEFAULT_BRANCH="master"
            else
              echo "Error: Could not determine default branch for ${{ matrix.repository }}"
              exit 1
            fi
          fi
          
          echo "Using default branch: $DEFAULT_BRANCH"
          
          # Checkout the default branch
          git checkout "$DEFAULT_BRANCH"
          git pull origin "$DEFAULT_BRANCH"
          
          # Check if branch already exists
          if git show-ref --verify --quiet refs/heads/"$BRANCH_NAME"; then
            echo "⚠️  Branch '$BRANCH_NAME' already exists locally, checking it out"
            git checkout "$BRANCH_NAME"
            git pull origin "$BRANCH_NAME" || true
          else
            # Create new branch
            git checkout -b "$BRANCH_NAME"
          fi
          
          # Push the new branch
          git push -u origin "$BRANCH_NAME"
          
          echo "✅ Successfully created/updated branch '$BRANCH_NAME' in ${{ matrix.repository }}"          
      - name: Update docker image for RequestManager repository
        env:
          BRANCH_NAME: ${{ inputs.branch_name }}        
        run: |          
          git checkout "$BRANCH_NAME"

          # List of docker-compose files to update
          # Collect all docker-compose files in the repository (recursively)
          DOCKER_COMPOSE_FILES=$(find . -type f -name "docker-compose*.yml" -o -name "docker-compose*.yaml")
          

          # Update all relevant CoverGo docker images from :master to :$BRANCH_NAME
          # Replace '/' with '-' in branch name for use in docker image tags
          SANITIZED_BRANCH_NAME=$(echo "$BRANCH_NAME" | tr '/' '-')          
          
          SERVICES="auth party cases claims3 filesystem policies users products pricing entity-management entity-diary finance channel-management notification-center task-management"
          for service in $SERVICES; do
            image_name=$(echo "$service" | tr '[:upper:]' '[:lower:]')
            old_img="image: ghcr.io/covergo/${image_name}:master"
            new_img="image: ghcr.io/covergo/${image_name}:${SANITIZED_BRANCH_NAME}"
            for dc_file in $DOCKER_COMPOSE_FILES; do
              sed -i "s|$old_img|$new_img|g" "$dc_file"
            done
            echo "Updated $service image in all docker-compose files"
          done
          # Check if there are any changes
          if git diff --quiet; then
            echo "⚠️  No changes detected"
            exit 0
          fi
          
          # Stage the file
          git add .
          
          # Commit the changes
          git commit -m "chore: update docker image for $BRANCH_NAME"
          
          # Push to the branch
          git push origin "$BRANCH_NAME"
          
          echo "✅ Successfully committed and pushed docker image update to $BRANCH_NAME"
      - name: Update build publish to use gamma branch for Reference repository
        env: 
          BRANCH_NAME: ${{ inputs.branch_name }}
        if: matrix.repository == 'chinh-trieu-covergo/Reference'
        run: |
          git checkout "$BRANCH_NAME"
          git pull origin "$BRANCH_NAME"
          BUILD_PUBLISH_FILE_PATH=".github/workflows/build-publish.yml"
          SANITIZED_BRANCH_NAME=$(echo "$BRANCH_NAME" | tr '/' '-') 
          # Check if 'branchForTag' exists under the 'with:' section. If it does, update its value.
          # If it doesn't, add it to the 'with:' section.          
          echo "
          if grep -A 20 "with:" "$BUILD_PUBLISH_FILE_PATH" | grep -q "branchForTag:"; then
            echo "Update existing branchForTag value"
            sed -i "s/^[[:space:]]*branchForTag:.*/branchForTag: $SANITIZED_BRANCH_NAME/" "$BUILD_PUBLISH_FILE_PATH"
          else
            echo "Inserted branchForTag: $SANITIZED_BRANCH_NAME after line $WITH_LINE"
          fi

          # Check if there are any changes
          if git diff --quiet; then
            echo "⚠️  No changes detected"
            exit 0
          fi

          git add .
          git commit -m "chore: update build publish to use gamma branch"
          git push origin $BRANCH_NAME
          echo "✅ Successfully committed and pushed build publish update to $BRANCH_NAME"
      - name: Update build publish to use gamma branch for RequestManager repository
        env: 
          BRANCH_NAME: ${{ inputs.branch_name }}
        if: matrix.repository == 'chinh-trieu-covergo/RequestManager'
        run: |
          git checkout "$BRANCH_NAME"
          git pull origin "$BRANCH_NAME"
          BUILD_PUBLISH_FILE_PATH=".github/workflows/build-publish.yml"
          SANITIZED_BRANCH_NAME=$(echo "$BRANCH_NAME" | tr '/' '-') 
          # Replace the line 'echo ::set-output name=docker_image_ghcr_tags::${ghcr_tags}' with the new value reflecting the gamma branch
          image_name="request-manager"
          # Using sed to replace all such echo lines, just in case multiple exist
          sed -i "s|echo ::set-output name=docker_image_ghcr_tags::.*|echo ::set-output name=docker_image_ghcr_tags::ghcr.io/covergo/request-manager:${SANITIZED_BRANCH_NAME}|" "$BUILD_PUBLISH_FILE_PATH"
          
