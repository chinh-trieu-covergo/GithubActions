# File generated by gflows, do not modify
# Source: build-publish-net/workflows/build-publish
name: Build and publish
"on":
- push
jobs:
  version:
    runs-on: ubuntu-latest
    name: Get version from git tag
    outputs:
      app_version: ${{ steps.version.outputs.semVer }}
      is_production: ${{ steps.is_production_check.outputs.is_production }}
      file_version: ${{ steps.version.outputs.assemblySemFileVer }}
      information_version: ${{ steps.version.outputs.informationalVersion }}
      issue_id_slug: ${{ steps.version.outputs.preReleaseLabel }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0
      with:
        versionSpec: 5.x
    - name: Determine Version
      id: version
      uses: gittools/actions/gitversion/execute@v0
      with:
        useConfigFile: true
    - name: Is production check
      shell: bash
      id: is_production_check
      run: |
        if [[ ${{ steps.version.outputs.semVer }} =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo ::set-output name=is_production::true
        fi
  nuget-build-request-manager-client:
    name: Build Request manager client nuget
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Request manager client nuget image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager-client
      with:
        file: Dockerfile
        push: false
        load: true
        tags: ghcr.io/covergo/request-manager-client:${{ needs.version.outputs.app_version }}
        cache-from: type=registry,ref=ghcr.io/covergo/request-manager-client-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-client-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: pack_client
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
          BUILD_DATETIME=${{ steps.meta.outputs.json && fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          APP_VERSION=${{ needs.version.outputs.app_version }}
          FILE_VERSION=${{ needs.version.outputs.file_version }}
          INFORMATIONAL_VERSION=${{ needs.version.outputs.information_version }}
        provenance: "false"
    - name: Image digest
      run: echo ${{ steps.docker-build-request-manager-client.outputs.digest }}
    - name: Create docker image with nuget packages
      run: docker create ghcr.io/covergo/request-manager-client:${{ needs.version.outputs.app_version }} --name nuget
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/docker-extract@v1.1", "covergo/docker-diagnose@v1.9", "covergo/set-compose-tags@v1.0.1", "covergo/run-in-compose@v2.0" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Extract nuget packages from docker image
      uses: ./.github/actions/docker-extract
      with:
        filter: ancestor=ghcr.io/covergo/request-manager-client:${{ needs.version.outputs.app_version }}
        container-path: app/nuget
        host-path: ./nuget
    - name: Upload nuget packages as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Nuget packages
        path: ./nuget
        include-hidden-files: true
  nuget-publish-request-manager-client:
    name: Publish Request manager client nuget
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - nuget-build-request-manager-client
    - run-request-manager-tests-acceptance-claims
    - run-request-manager-tests-acceptance-notifications
    - run-request-manager-tests-acceptance-party
    - run-request-manager-tests-acceptance-reference
    - run-request-manager-tests-acceptance-task
    - run-request-manager-tests-unit
    steps:
    - uses: actions/download-artifact@v4
      with:
        name: Nuget packages
        path: ./nuget
    - name: Push generated package to GitHub registry
      run: dotnet nuget push ./nuget/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate --source https://nuget.pkg.github.com/covergo/index.json
    - name: Push generated package symbols to GitHub registry
      run: dotnet nuget push ./nuget/*.snupkg --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate --source https://nuget.pkg.github.com/covergo/index.json
  docker-build-request-manager:
    name: Build Service image
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    outputs:
      digest: ${{ steps.docker-build-request-manager.outputs.digest }}
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Service image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager
      with:
        file: Dockerfile
        push: true
        load: false
        tags: ghcr.io/covergo/request-manager:candidate-${{ needs.version.outputs.app_version }}
        cache-from: type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: runtime
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
          BUILD_DATETIME=${{ steps.meta.outputs.json && fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
          APP_VERSION=${{ needs.version.outputs.app_version }}
          FILE_VERSION=${{ needs.version.outputs.file_version }}
          INFORMATIONAL_VERSION=${{ needs.version.outputs.information_version }}
        provenance: "false"
    - name: Image digest
      env:
        docker_digest: ${{ steps.docker-build-request-manager.outputs.digest }}
      run: |
        echo $docker_digest
        echo "digest=$docker_digest" >> $GITHUB_OUTPUT
  docker-build-request-manager-tests-unit:
    name: Build Unit tests image
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager
    env:
      RESULTS_PATH: ./TestResults
      UNIT_TEST_IMAGE_TAG: ghcr.io/covergo/request-manager-tests-unit:${{ needs.version.outputs.app_version }}
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Unit tests image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager-tests-unit
      with:
        file: Dockerfile
        push: true
        load: false
        tags: ghcr.io/covergo/request-manager-tests-unit:${{ needs.version.outputs.app_version }}
        cache-from: |-
          type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
          type=registry,ref=ghcr.io/covergo/request-manager-tests-unit-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-tests-unit-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: run_tests_unit
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
        provenance: "false"
    - name: Image digest
      run: echo ${{ steps.docker-build-request-manager-tests-unit.outputs.digest }}
  run-request-manager-tests-unit:
    name: Run Unit tests
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager-tests-unit
    env:
      RESULTS_PATH: ./TestResults
      UNIT_TEST_IMAGE_TAG: ghcr.io/covergo/request-manager-tests-unit:${{ needs.version.outputs.app_version }}
      IMAGE_RUN_ARGS: ""
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/docker-extract@v1.1", "covergo/docker-diagnose@v1.9", "covergo/set-compose-tags@v1.0.1", "covergo/run-in-compose@v2.0" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Pull image covergo/request-manager-tests-unit
      run: docker pull $UNIT_TEST_IMAGE_TAG
    - name: Run Unit tests
      run: |
        id=$(docker images "$UNIT_TEST_IMAGE_TAG" -q | head -n 1)
        echo "found image id: $id"
        docker run --name unit_tests $id $IMAGE_RUN_ARGS
    - name: Collect Unit tests results
      if: always()
      uses: ./.github/actions/docker-extract
      with:
        filter: ancestor=$UNIT_TEST_IMAGE_TAG
        container-path: app/TestResults
        host-path: ./TestResults
    - name: Upload Unit tests results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Unit tests results
        path: TestResults
        include-hidden-files: true
    - name: Publish Unit tests results as check
      uses: docker://ghcr.io/enricomi/publish-unit-test-result-action:latest
      continue-on-error: true
      if: always()
      with:
        report_individual_runs: "true"
        check_name: Unit tests check
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: ./TestResults/TestResults.xml
        github_retries: 3
        comment_mode: false
        compare_to_earlier_commit: false
        check_run: false
        check_run_annotations: none
  docker-build-request-manager-tests-acceptance-claims:
    name: Build Claims Acceptance tests Elsa MongoDB image
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Claims Acceptance tests Elsa MongoDB image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager-tests-acceptance-claims
      with:
        file: Dockerfile
        push: true
        load: false
        tags: ghcr.io/covergo/request-manager-tests-acceptance-claims:${{ needs.version.outputs.app_version }}
        cache-from: |-
          type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
          type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-claims-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-claims-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: run_tests_acceptance_claims
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
        provenance: "false"
    - name: Image digest
      run: echo ${{ steps.docker-build-request-manager-tests-acceptance-claims.outputs.digest }}
  run-request-manager-tests-acceptance-claims:
    name: Run Claims Acceptance tests Elsa MongoDB
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager-tests-acceptance-claims
    env:
      RESULTS_PATH: ./TestResults

    if: |
        always() &&
        (vars.SKIP_GAMMA_TEST != 'true' || !startsWith(github.ref_name, 'gamma/'))
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/docker-extract@v1.1", "covergo/docker-diagnose@v1.9", "covergo/set-compose-tags@v1.0.1", "covergo/run-in-compose@v2.0" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager;covergo/request-manager-tests-unit;covergo/request-manager-tests-acceptance-claims;covergo/request-manager-tests-acceptance-notifications;covergo/request-manager-tests-acceptance-party;covergo/request-manager-tests-acceptance-reference;covergo/request-manager-tests-acceptance-task
        target-tag: ${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-claims.yml
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager
        target-tag: candidate-${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-claims.yml
    - name: Run Claims Acceptance tests Elsa MongoDB
      uses: ./.github/actions/run-in-compose
      with:
        compose-file: docker-compose-tests-acceptance-mongodb-claims.yml
        service-name: request-manager-tests-acceptance-claims
        project-name: integration-test
        env-vars: '{"GOOGLE_APPLICATION_CREDENTIALS":"${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"}'
    - name: Collect Claims Acceptance tests Elsa MongoDB results
      if: always()
      uses: ./.github/actions/docker-extract
      with:
        filter: ancestor=ghcr.io/covergo/request-manager-tests-acceptance-claims:${{ needs.version.outputs.app_version }}
        container-path: app/TestResults
        host-path: ./TestResults
    - name: Gather test environment logs
      if: always()
      uses: ./.github/actions/docker-diagnose
      with:
        filter: name=request*
        diagnostic-result-path: investigate
        include-compose: true
        encrypt-password: ${{ secrets.DIAGNOSTIC_PASSWORD }}$GITHUB_RUN_NUMBER
        compose-file: docker-compose-tests-acceptance-mongodb-claims.yml
        project-name: integration-test
    - name: Upload Claims Acceptance tests Elsa MongoDB environment diagnostics as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Claims Acceptance tests Elsa MongoDB environment diagnostics
        path: investigate/*
        include-hidden-files: true
    - name: Upload Claims Acceptance tests Elsa MongoDB results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Claims Acceptance tests Elsa MongoDB results
        path: TestResults
        include-hidden-files: true
    - name: Publish Claims Acceptance tests Elsa MongoDB results as check
      uses: docker://ghcr.io/enricomi/publish-unit-test-result-action:latest
      continue-on-error: true
      if: always()
      with:
        report_individual_runs: "true"
        check_name: Claims Acceptance tests Elsa MongoDB check
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: ./TestResults/TestResults.xml
        github_retries: 3
        comment_mode: false
        compare_to_earlier_commit: false
        check_run: false
        check_run_annotations: none
    - name: Upload Claims Acceptance tests Elsa MongoDB results to Behave.Pro
      if: always()
      env:
        behave_api_key: ${{ secrets.BEHAVE_PRO_TOKEN }}
        build_id: ${{ github.run_id }}
        build_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        results_file_filter: ./TestResults/cucumberResult.json
      run: |
        latest_commit_sha=$(git rev-parse HEAD)
        echo "commit sha: $latest_commit_sha"
        echo "test result file filter: $results_file_filter"
        for results_file in $(ls "$results_file_filter")
        do
          echo uploading "$results_file"
          curl -L -X PUT --fail https://test-reports.behave.pro/REST/1.0/bdd/report \
          -H "X-API-KEY: $behave_api_key" \
          -H "X-COMMIT-ID: $latest_commit_sha" \
          -H "X-BUILD-ID: $build_id" \
          -H "X-BUILD-URL: $build_url" \
          --data-binary @"$results_file"
        done
    - name: Publish Claims Acceptance tests Elsa MongoDB results as check
      uses: deblockt/cucumber-report-annotations-action@v1.11
      if: always()
      with:
        name: Claims Acceptance tests Elsa MongoDB check
        access-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./TestResults/cucumberResult.json
  docker-build-request-manager-tests-acceptance-notifications:
    name: Build Notifications Acceptance tests Elsa MongoDB image
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Notifications Acceptance tests Elsa MongoDB image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager-tests-acceptance-notifications
      with:
        file: Dockerfile
        push: true
        load: false
        tags: ghcr.io/covergo/request-manager-tests-acceptance-notifications:${{ needs.version.outputs.app_version }}
        cache-from: |-
          type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
          type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-notifications-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-notifications-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: run_tests_acceptance_notifications
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
        provenance: "false"
    - name: Image digest
      run: echo ${{ steps.docker-build-request-manager-tests-acceptance-notifications.outputs.digest }}
  run-request-manager-tests-acceptance-notifications:
    name: Run Notifications Acceptance tests Elsa MongoDB
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager-tests-acceptance-notifications
    env:
      RESULTS_PATH: ./TestResults
    if: |
        always() &&
        (vars.SKIP_GAMMA_TEST != 'true' || !startsWith(github.ref_name, 'gamma/'))
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/docker-extract@v1.1", "covergo/docker-diagnose@v1.9", "covergo/set-compose-tags@v1.0.1", "covergo/run-in-compose@v2.0" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager;covergo/request-manager-tests-unit;covergo/request-manager-tests-acceptance-claims;covergo/request-manager-tests-acceptance-notifications;covergo/request-manager-tests-acceptance-party;covergo/request-manager-tests-acceptance-reference;covergo/request-manager-tests-acceptance-task
        target-tag: ${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-notifications.yml
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager
        target-tag: candidate-${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-notifications.yml
    - name: Run Notifications Acceptance tests Elsa MongoDB
      uses: ./.github/actions/run-in-compose
      with:
        compose-file: docker-compose-tests-acceptance-mongodb-notifications.yml
        service-name: request-manager-tests-acceptance-notifications
        project-name: integration-test
        env-vars: '{"GOOGLE_APPLICATION_CREDENTIALS":"${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"}'
    - name: Collect Notifications Acceptance tests Elsa MongoDB results
      if: always()
      uses: ./.github/actions/docker-extract
      with:
        filter: ancestor=ghcr.io/covergo/request-manager-tests-acceptance-notifications:${{ needs.version.outputs.app_version }}
        container-path: app/TestResults
        host-path: ./TestResults
    - name: Gather test environment logs
      if: always()
      uses: ./.github/actions/docker-diagnose
      with:
        filter: name=request*
        diagnostic-result-path: investigate
        include-compose: true
        encrypt-password: ${{ secrets.DIAGNOSTIC_PASSWORD }}$GITHUB_RUN_NUMBER
        compose-file: docker-compose-tests-acceptance-mongodb-notifications.yml
        project-name: integration-test
    - name: Upload Notifications Acceptance tests Elsa MongoDB environment diagnostics as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Notifications Acceptance tests Elsa MongoDB environment diagnostics
        path: investigate/*
        include-hidden-files: true
    - name: Upload Notifications Acceptance tests Elsa MongoDB results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Notifications Acceptance tests Elsa MongoDB results
        path: TestResults
        include-hidden-files: true
    - name: Publish Notifications Acceptance tests Elsa MongoDB results as check
      uses: docker://ghcr.io/enricomi/publish-unit-test-result-action:latest
      continue-on-error: true
      if: always()
      with:
        report_individual_runs: "true"
        check_name: Notifications Acceptance tests Elsa MongoDB check
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: ./TestResults/TestResults.xml
        github_retries: 3
        comment_mode: false
        compare_to_earlier_commit: false
        check_run: false
        check_run_annotations: none
    - name: Upload Notifications Acceptance tests Elsa MongoDB results to Behave.Pro
      if: always()
      env:
        behave_api_key: ${{ secrets.BEHAVE_PRO_TOKEN }}
        build_id: ${{ github.run_id }}
        build_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        results_file_filter: ./TestResults/cucumberResult.json
      run: |
        latest_commit_sha=$(git rev-parse HEAD)
        echo "commit sha: $latest_commit_sha"
        echo "test result file filter: $results_file_filter"
        for results_file in $(ls "$results_file_filter")
        do
          echo uploading "$results_file"
          curl -L -X PUT --fail https://test-reports.behave.pro/REST/1.0/bdd/report \
          -H "X-API-KEY: $behave_api_key" \
          -H "X-COMMIT-ID: $latest_commit_sha" \
          -H "X-BUILD-ID: $build_id" \
          -H "X-BUILD-URL: $build_url" \
          --data-binary @"$results_file"
        done
    - name: Publish Notifications Acceptance tests Elsa MongoDB results as check
      uses: deblockt/cucumber-report-annotations-action@v1.11
      if: always()
      with:
        name: Notifications Acceptance tests Elsa MongoDB check
        access-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./TestResults/cucumberResult.json
  docker-build-request-manager-tests-acceptance-party:
    name: Build Party Acceptance tests Elsa MongoDB image
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Party Acceptance tests Elsa MongoDB image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager-tests-acceptance-party
      with:
        file: Dockerfile
        push: true
        load: false
        tags: ghcr.io/covergo/request-manager-tests-acceptance-party:${{ needs.version.outputs.app_version }}
        cache-from: |-
          type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
          type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-party-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-party-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: run_tests_acceptance_party
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
        provenance: "false"
    - name: Image digest
      run: echo ${{ steps.docker-build-request-manager-tests-acceptance-party.outputs.digest }}
  run-request-manager-tests-acceptance-party:
    name: Run Party Acceptance tests Elsa MongoDB
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager-tests-acceptance-party
    env:
      RESULTS_PATH: ./TestResults
    if: |
        always() &&
        (vars.SKIP_GAMMA_TEST != 'true' || !startsWith(github.ref_name, 'gamma/'))
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/docker-extract@v1.1", "covergo/docker-diagnose@v1.9", "covergo/set-compose-tags@v1.0.1", "covergo/run-in-compose@v2.0" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager;covergo/request-manager-tests-unit;covergo/request-manager-tests-acceptance-claims;covergo/request-manager-tests-acceptance-notifications;covergo/request-manager-tests-acceptance-party;covergo/request-manager-tests-acceptance-reference;covergo/request-manager-tests-acceptance-task
        target-tag: ${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-party.yml
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager
        target-tag: candidate-${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-party.yml
    - name: Run Party Acceptance tests Elsa MongoDB
      uses: ./.github/actions/run-in-compose
      with:
        compose-file: docker-compose-tests-acceptance-mongodb-party.yml
        service-name: request-manager-tests-acceptance-party
        project-name: integration-test
        env-vars: '{"GOOGLE_APPLICATION_CREDENTIALS":"${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"}'
    - name: Collect Party Acceptance tests Elsa MongoDB results
      if: always()
      uses: ./.github/actions/docker-extract
      with:
        filter: ancestor=ghcr.io/covergo/request-manager-tests-acceptance-party:${{ needs.version.outputs.app_version }}
        container-path: app/TestResults
        host-path: ./TestResults
    - name: Gather test environment logs
      if: always()
      uses: ./.github/actions/docker-diagnose
      with:
        filter: name=request*
        diagnostic-result-path: investigate
        include-compose: true
        encrypt-password: ${{ secrets.DIAGNOSTIC_PASSWORD }}$GITHUB_RUN_NUMBER
        compose-file: docker-compose-tests-acceptance-mongodb-party.yml
        project-name: integration-test
    - name: Upload Party Acceptance tests Elsa MongoDB environment diagnostics as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Party Acceptance tests Elsa MongoDB environment diagnostics
        path: investigate/*
        include-hidden-files: true
    - name: Upload Party Acceptance tests Elsa MongoDB results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Party Acceptance tests Elsa MongoDB results
        path: TestResults
        include-hidden-files: true
    - name: Publish Party Acceptance tests Elsa MongoDB results as check
      uses: docker://ghcr.io/enricomi/publish-unit-test-result-action:latest
      continue-on-error: true
      if: always()
      with:
        report_individual_runs: "true"
        check_name: Party Acceptance tests Elsa MongoDB check
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: ./TestResults/TestResults.xml
        github_retries: 3
        comment_mode: false
        compare_to_earlier_commit: false
        check_run: false
        check_run_annotations: none
    - name: Upload Party Acceptance tests Elsa MongoDB results to Behave.Pro
      if: always()
      env:
        behave_api_key: ${{ secrets.BEHAVE_PRO_TOKEN }}
        build_id: ${{ github.run_id }}
        build_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        results_file_filter: ./TestResults/cucumberResult.json
      run: |
        latest_commit_sha=$(git rev-parse HEAD)
        echo "commit sha: $latest_commit_sha"
        echo "test result file filter: $results_file_filter"
        for results_file in $(ls "$results_file_filter")
        do
          echo uploading "$results_file"
          curl -L -X PUT --fail https://test-reports.behave.pro/REST/1.0/bdd/report \
          -H "X-API-KEY: $behave_api_key" \
          -H "X-COMMIT-ID: $latest_commit_sha" \
          -H "X-BUILD-ID: $build_id" \
          -H "X-BUILD-URL: $build_url" \
          --data-binary @"$results_file"
        done
    - name: Publish Party Acceptance tests Elsa MongoDB results as check
      uses: deblockt/cucumber-report-annotations-action@v1.11
      if: always()
      with:
        name: Party Acceptance tests Elsa MongoDB check
        access-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./TestResults/cucumberResult.json
  docker-build-request-manager-tests-acceptance-reference:
    name: Build Reference Acceptance tests Elsa MongoDB image
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Reference Acceptance tests Elsa MongoDB image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager-tests-acceptance-reference
      with:
        file: Dockerfile
        push: true
        load: false
        tags: ghcr.io/covergo/request-manager-tests-acceptance-reference:${{ needs.version.outputs.app_version }}
        cache-from: |-
          type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
          type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-reference-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-reference-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: run_tests_acceptance_reference
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
        provenance: "false"
    - name: Image digest
      run: echo ${{ steps.docker-build-request-manager-tests-acceptance-reference.outputs.digest }}
  run-request-manager-tests-acceptance-reference:
    name: Run Reference Acceptance tests Elsa MongoDB
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager-tests-acceptance-reference
    env:
      RESULTS_PATH: ./TestResults
    if: |
        always() &&
        (vars.SKIP_GAMMA_TEST != 'true' || !startsWith(github.ref_name, 'gamma/'))
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/docker-extract@v1.1", "covergo/docker-diagnose@v1.9", "covergo/set-compose-tags@v1.0.1", "covergo/run-in-compose@v2.0" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager;covergo/request-manager-tests-unit;covergo/request-manager-tests-acceptance-claims;covergo/request-manager-tests-acceptance-notifications;covergo/request-manager-tests-acceptance-party;covergo/request-manager-tests-acceptance-reference;covergo/request-manager-tests-acceptance-task
        target-tag: ${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-reference.yml
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager
        target-tag: candidate-${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-reference.yml
    - name: Run Reference Acceptance tests Elsa MongoDB
      uses: ./.github/actions/run-in-compose
      with:
        compose-file: docker-compose-tests-acceptance-mongodb-reference.yml
        service-name: request-manager-tests-acceptance-reference
        project-name: integration-test
        env-vars: '{"GOOGLE_APPLICATION_CREDENTIALS":"${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"}'
    - name: Collect Reference Acceptance tests Elsa MongoDB results
      if: always()
      uses: ./.github/actions/docker-extract
      with:
        filter: ancestor=ghcr.io/covergo/request-manager-tests-acceptance-reference:${{ needs.version.outputs.app_version }}
        container-path: app/TestResults
        host-path: ./TestResults
    - name: Gather test environment logs
      if: always()
      uses: ./.github/actions/docker-diagnose
      with:
        filter: name=request*
        diagnostic-result-path: investigate
        include-compose: true
        encrypt-password: ${{ secrets.DIAGNOSTIC_PASSWORD }}$GITHUB_RUN_NUMBER
        compose-file: docker-compose-tests-acceptance-mongodb-reference.yml
        project-name: integration-test
    - name: Upload Reference Acceptance tests Elsa MongoDB environment diagnostics as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Reference Acceptance tests Elsa MongoDB environment diagnostics
        path: investigate/*
        include-hidden-files: true
    - name: Upload Reference Acceptance tests Elsa MongoDB results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Reference Acceptance tests Elsa MongoDB results
        path: TestResults
        include-hidden-files: true
    - name: Publish Reference Acceptance tests Elsa MongoDB results as check
      uses: docker://ghcr.io/enricomi/publish-unit-test-result-action:latest
      continue-on-error: true
      if: always()
      with:
        report_individual_runs: "true"
        check_name: Reference Acceptance tests Elsa MongoDB check
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: ./TestResults/TestResults.xml
        github_retries: 3
        comment_mode: false
        compare_to_earlier_commit: false
        check_run: false
        check_run_annotations: none
    - name: Upload Reference Acceptance tests Elsa MongoDB results to Behave.Pro
      if: always()
      env:
        behave_api_key: ${{ secrets.BEHAVE_PRO_TOKEN }}
        build_id: ${{ github.run_id }}
        build_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        results_file_filter: ./TestResults/cucumberResult.json
      run: |
        latest_commit_sha=$(git rev-parse HEAD)
        echo "commit sha: $latest_commit_sha"
        echo "test result file filter: $results_file_filter"
        for results_file in $(ls "$results_file_filter")
        do
          echo uploading "$results_file"
          curl -L -X PUT --fail https://test-reports.behave.pro/REST/1.0/bdd/report \
          -H "X-API-KEY: $behave_api_key" \
          -H "X-COMMIT-ID: $latest_commit_sha" \
          -H "X-BUILD-ID: $build_id" \
          -H "X-BUILD-URL: $build_url" \
          --data-binary @"$results_file"
        done
    - name: Publish Reference Acceptance tests Elsa MongoDB results as check
      uses: deblockt/cucumber-report-annotations-action@v1.11
      if: always()
      with:
        name: Reference Acceptance tests Elsa MongoDB check
        access-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./TestResults/cucumberResult.json
  docker-build-request-manager-tests-acceptance-task:
    name: Build Task Acceptance tests Elsa MongoDB image
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      with:
        version: v0.11.2
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Build Task Acceptance tests Elsa MongoDB image
      uses: docker/build-push-action@v3
      id: docker-build-request-manager-tests-acceptance-task
      with:
        file: Dockerfile
        push: true
        load: false
        tags: ghcr.io/covergo/request-manager-tests-acceptance-task:${{ needs.version.outputs.app_version }}
        cache-from: |-
          type=registry,ref=ghcr.io/covergo/request-manager-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
          type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-task-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }}
        cache-to: type=registry,ref=ghcr.io/covergo/request-manager-tests-acceptance-task-cache:${{ needs.version.outputs.issue_id_slug != '' && needs.version.outputs.issue_id_slug || 'cache' }},mode=max
        target: run_tests_acceptance_task
        build-args: |-
          COMMIT_SHA=${{ github.sha }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          GH_ACCOUNT=${{ secrets.PAT_USER_READ_PACKAGES }}
          GH_TOKEN=${{ secrets.PAT_READ_PACKAGES }}
        provenance: "false"
    - name: Image digest
      run: echo ${{ steps.docker-build-request-manager-tests-acceptance-task.outputs.digest }}
  run-request-manager-tests-acceptance-task:
    name: Run Task Acceptance tests Elsa MongoDB
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager-tests-acceptance-task
    env:
      RESULTS_PATH: ./TestResults
    if: |
        always() &&
        (vars.SKIP_GAMMA_TEST != 'true' || !startsWith(github.ref_name, 'gamma/'))
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/docker-extract@v1.1", "covergo/docker-diagnose@v1.9", "covergo/set-compose-tags@v1.0.1", "covergo/run-in-compose@v2.0" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager;covergo/request-manager-tests-unit;covergo/request-manager-tests-acceptance-claims;covergo/request-manager-tests-acceptance-notifications;covergo/request-manager-tests-acceptance-party;covergo/request-manager-tests-acceptance-reference;covergo/request-manager-tests-acceptance-task
        target-tag: ${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-task.yml
    - name: Prepare compose file
      uses: ./.github/actions/set-compose-tags
      with:
        images: covergo/request-manager
        target-tag: candidate-${{ needs.version.outputs.app_version }}
        compose-file: docker-compose-tests-acceptance-mongodb-task.yml
    - name: Run Task Acceptance tests Elsa MongoDB
      uses: ./.github/actions/run-in-compose
      with:
        compose-file: docker-compose-tests-acceptance-mongodb-task.yml
        service-name: request-manager-tests-acceptance-task
        project-name: integration-test
        env-vars: '{"GOOGLE_APPLICATION_CREDENTIALS":"${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}"}'
    - name: Collect Task Acceptance tests Elsa MongoDB results
      if: always()
      uses: ./.github/actions/docker-extract
      with:
        filter: ancestor=ghcr.io/covergo/request-manager-tests-acceptance-task:${{ needs.version.outputs.app_version }}
        container-path: app/TestResults
        host-path: ./TestResults
    - name: Gather test environment logs
      if: always()
      uses: ./.github/actions/docker-diagnose
      with:
        filter: name=request*
        diagnostic-result-path: investigate
        include-compose: true
        encrypt-password: ${{ secrets.DIAGNOSTIC_PASSWORD }}$GITHUB_RUN_NUMBER
        compose-file: docker-compose-tests-acceptance-mongodb-task.yml
        project-name: integration-test
    - name: Upload Task Acceptance tests Elsa MongoDB environment diagnostics as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Task Acceptance tests Elsa MongoDB environment diagnostics
        path: investigate/*
        include-hidden-files: true
    - name: Upload Task Acceptance tests Elsa MongoDB results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Task Acceptance tests Elsa MongoDB results
        path: TestResults
        include-hidden-files: true
    - name: Publish Task Acceptance tests Elsa MongoDB results as check
      uses: docker://ghcr.io/enricomi/publish-unit-test-result-action:latest
      continue-on-error: true
      if: always()
      with:
        report_individual_runs: "true"
        check_name: Task Acceptance tests Elsa MongoDB check
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: ./TestResults/TestResults.xml
        github_retries: 3
        comment_mode: false
        compare_to_earlier_commit: false
        check_run: false
        check_run_annotations: none
    - name: Upload Task Acceptance tests Elsa MongoDB results to Behave.Pro
      if: always()
      env:
        behave_api_key: ${{ secrets.BEHAVE_PRO_TOKEN }}
        build_id: ${{ github.run_id }}
        build_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        results_file_filter: ./TestResults/cucumberResult.json
      run: |
        latest_commit_sha=$(git rev-parse HEAD)
        echo "commit sha: $latest_commit_sha"
        echo "test result file filter: $results_file_filter"
        for results_file in $(ls "$results_file_filter")
        do
          echo uploading "$results_file"
          curl -L -X PUT --fail https://test-reports.behave.pro/REST/1.0/bdd/report \
          -H "X-API-KEY: $behave_api_key" \
          -H "X-COMMIT-ID: $latest_commit_sha" \
          -H "X-BUILD-ID: $build_id" \
          -H "X-BUILD-URL: $build_url" \
          --data-binary @"$results_file"
        done
    - name: Publish Task Acceptance tests Elsa MongoDB results as check
      uses: deblockt/cucumber-report-annotations-action@v1.11
      if: always()
      with:
        name: Task Acceptance tests Elsa MongoDB check
        access-token: ${{ secrets.GITHUB_TOKEN }}
        path: ./TestResults/cucumberResult.json
  docker-publish-github-request-manager:
    name: Tag service image in GitHub
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
    - version
    - docker-build-request-manager
    - run-request-manager-tests-acceptance-claims
    - run-request-manager-tests-acceptance-notifications
    - run-request-manager-tests-acceptance-party
    - run-request-manager-tests-acceptance-reference
    - run-request-manager-tests-acceptance-task
    - run-request-manager-tests-unit
    if: |
        always() &&
        (needs.run-request-manager-tests-acceptance-claims == 'success' || needs.run-request-manager-tests-acceptance-claims == 'skipped') &&
        (needs.run-request-manager-tests-acceptance-notifications == 'success' || needs.run-request-manager-tests-acceptance-notifications == 'skipped') &&
        (needs.run-request-manager-tests-acceptance-party == 'success' || needs.run-request-manager-tests-acceptance-party == 'skipped') &&
        (needs.run-request-manager-tests-acceptance-reference == 'success' || needs.run-request-manager-tests-acceptance-reference == 'skipped') &&
        (needs.run-request-manager-tests-acceptance-task == 'success' || needs.run-request-manager-tests-acceptance-task == 'skipped') &&
        (needs.run-request-manager-tests-unit == 'success' || needs.run-request-manager-tests-unit == 'skipped')
    steps:
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Get docker image tags
      id: github-tags-request-manager
      env:
        versioned_tag: ghcr.io/covergo/request-manager:${{ needs.version.outputs.app_version }}
        latest_tag: ghcr.io/covergo/request-manager:latest
        master_tag: ghcr.io/covergo/request-manager:master
      run: |2

        ghcr_tags=${versioned_tag}

        branch=$(git branch --show-current)
        if [[ "$branch" = 'main' || "$branch" = 'master'  ]]; then
          ghcr_tags="${ghcr_tags},${master_tag}"
        fi

        if [[ ${GITHUB_REF}  == refs/tags/v* ]]; then
          ghcr_tags="${ghcr_tags},${latest_tag}"
        fi

        echo final tags for ghcr are:  ${ghcr_tags}
        echo ::set-output name=docker_image_ghcr_tags::${ghcr_tags}
    - name: Push Image to GitHub Container Registry
      uses: akhilerm/tag-push-action@v2.1.0
      with:
        src: ghcr.io/covergo/request-manager:candidate-${{ needs.version.outputs.app_version }}
        dst: ${{ steps.github-tags-request-manager.outputs.docker_image_ghcr_tags }}
    - name: Set up sigstore cosign
      uses: sigstore/cosign-installer@main
    - name: Sign published container image
      run: cosign sign --key env://COSIGN_PRIVATE_KEY ghcr.io/covergo/request-manager:${{ needs.version.outputs.app_version }}@${{ needs.docker-build-request-manager.outputs.digest }}
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
  docker-publish-alicloud-request-manager:
    name: Push service to AliCloud
    timeout-minutes: 10
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs:
    - version
    - docker-build-request-manager
    - docker-publish-github-request-manager
    - run-request-manager-tests-acceptance-claims
    - run-request-manager-tests-acceptance-notifications
    - run-request-manager-tests-acceptance-party
    - run-request-manager-tests-acceptance-reference
    - run-request-manager-tests-acceptance-task
    - run-request-manager-tests-unit
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v2
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Get docker image tags
      id: alicloud-tags-request-manager
      env:
        versioned_tag: registry-intl.cn-hongkong.aliyuncs.com/covergo/request-manager:${{ needs.version.outputs.app_version }}
        latest_tag: registry-intl.cn-hongkong.aliyuncs.com/covergo/request-manager:latest
        master_tag: registry-intl.cn-hongkong.aliyuncs.com/covergo/request-manager:master
      run: |2

        ali_cloud_tags=${versioned_tag}

        branch=$(git branch --show-current)
        if [[ "$branch" = 'main' || "$branch" = 'master'  ]]; then
          ali_cloud_tags="${ali_cloud_tags},${master_tag}"
        fi

        if [[ ${GITHUB_REF}  == refs/tags/v* ]]; then
          ali_cloud_tags="${ali_cloud_tags},${latest_tag}"
        fi

        echo final tags for ali are: ${ali_cloud_tags}
        echo ::set-output name=docker_image_ali_cloud_tags::${ali_cloud_tags}
    - name: Push Image to AliCloud Container Registry
      uses: akhilerm/tag-push-action@v2.1.0
      with:
        src: ghcr.io/covergo/request-manager:${{ needs.version.outputs.app_version }}
        dst: ${{ steps.alicloud-tags-request-manager.outputs.docker_image_ali_cloud_tags }}
    - if: github.ref_type == 'tag'
      name: Publish helm chart
      uses: peter-evans/repository-dispatch@v2
      with:
        event-type: helm_release
        client-payload: '{"ref_name": "${{ github.ref_name }}"}'
    - name: Set up sigstore cosign
      uses: sigstore/cosign-installer@main
    - name: Sign published container image
      run: cosign sign --key env://COSIGN_PRIVATE_KEY registry-intl.cn-hongkong.aliyuncs.com/covergo/request-manager:${{ needs.version.outputs.app_version }}@${{ needs.docker-build-request-manager.outputs.digest }}
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
